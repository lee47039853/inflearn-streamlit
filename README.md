# 📚 소득세 챗봇 (RAG 기반)

소득세 관련 질문에 대해 RAG(Retrieval-Augmented Generation) 기술을 활용하여 정확하고 신뢰할 수 있는 답변을 제공하는 Streamlit 기반 챗봇입니다.

## 🚀 주요 기능

### 🎭 **듀얼 인터페이스**

- **👤 사용자 모드**: 간단하고 안전한 채팅 인터페이스
- **🛠️ 관리자 모드**: 완전한 시스템 제어 및 모니터링

### 🧠 **RAG 시스템**

- **문서 기반 정확한 답변**: 소득세 관련 문서 검색 후 답변 생성
- **쿼리 최적화**: 사용자 질문을 세금 관련 용어로 개선
- **실시간 문서 참조**: 답변에 사용된 참고 문서 표시

### 👥 **멀티 사용자 지원**

- **공유 리소스 관리**: 효율적인 다중 사용자 처리
- **개별 세션 관리**: 사용자별 독립적인 대화 히스토리
- **리소스 캐싱**: 임베딩 모델, 데이터베이스, LLM 공유로 메모리 효율성 향상

### 🔧 **고급 기능**

- **다중 임베딩 모델**: 한국어 특화 모델과 Google Gemini 모델 지원
- **데이터베이스 관리**: 생성/재사용/삭제 옵션 (관리자)
- **자동 API 키 로드**: .env 파일에서 Google API 키 자동 로드
- **실시간 모니터링**: 공유 리소스 상태 및 메모리 절약 현황 표시

## 📋 시스템 요구사항

- Python 3.8 이상
- Google Gemini API 키
- 최소 4GB RAM (단일 사용자), 6GB+ RAM 권장 (멀티 사용자)
- 인터넷 연결 (모델 다운로드 및 API 호출)

## ⚡ 빠른 시작

### 👤 **일반 사용자용 (권장)**

```bash
# 1. 저장소 클론
git clone <repository-url>
cd inflearn-streamlit

# 2. 의존성 설치
pip install -r requirements.txt

# 3. .env 파일 생성 및 API 키 설정 (선택사항)
cp env_example.txt .env
# .env 파일에서 GOOGLE_API_KEY=your-api-key-here 설정

# 4. 사용자 모드 실행
python run.py
# 브라우저: http://localhost:8501
```

### 🛠️ **관리자용**

```bash
# 관리자 모드 실행
python run_admin.py
# 브라우저: http://localhost:8502
```

### 🎭 **통합 런처 (launcher.py)**

```bash
# 대화형 모드 선택 메뉴
python launcher.py
```

**실행 후 나타나는 메뉴:**

```
🚀 소득세 챗봇 시스템
==================================================
실행할 모드를 선택하세요:
1. 👤 일반 사용자 모드 (포트 8501)
2. 🛠️  관리자 모드 (포트 8502)
3. 🔄 두 모드 동시 실행
4. ❌ 종료
==================================================
선택 (1-4):
```

## 🛠️ 설치 방법

### 1. 저장소 클론

```bash
git clone <repository-url>
cd inflearn-streamlit
```

### 2. 가상환경 생성 및 활성화

```bash
python -m venv venv
# Windows
venv\Scripts\activate
# macOS/Linux
source venv/bin/activate
```

### 3. 의존성 설치

```bash
pip install -r requirements.txt
```

### 4. Google API 키 설정

Google AI Studio에서 API 키를 발급받아 `.env` 파일에 설정하거나, 애플리케이션 실행 시 입력하세요.

#### 방법 1: .env 파일 사용 (권장)

```bash
# .env 파일 생성
cp env_example.txt .env

# .env 파일 편집하여 API 키 입력
# GOOGLE_API_KEY=your-actual-api-key-here
```

#### 방법 2: 환경변수 설정

```bash
# 환경변수 설정 (선택사항)
export GOOGLE_API_KEY="your-api-key-here"
```

## 🎯 사용 방법

### 🎭 **두 가지 인터페이스**

이 시스템은 **일반 사용자**와 **관리자**를 위한 별도 인터페이스를 제공합니다.

#### 👤 **일반 사용자 (권장)**

- **간단하고 안전한 채팅 인터페이스**
- **자동 시스템 설정**
- **위험한 관리 기능 숨김**

#### 🛠️ **관리자**

- **완전한 시스템 제어권**
- **데이터베이스 관리**
- **리소스 모니터링**

---

### 1️⃣ **일반 사용자 실행 방법**

#### 방법 1: 간단 실행 (권장)

```bash
python run.py
```

**접속**: http://localhost:8501

#### 방법 2: 직접 실행

```bash
streamlit run app.py
```

#### 방법 3: Unix/Linux/macOS에서 직접 실행

```bash
# 실행 권한 부여 (최초 1회)
chmod +x run.py

# 실행
./run.py
```

---

### 2️⃣ **관리자 실행 방법**

#### 방법 1: 관리자 전용 스크립트

```bash
python run_admin.py
```

**접속**: http://localhost:8502

#### 방법 2: 직접 실행

```bash
streamlit run admin.py --server.port 8502
```

---

### 3️⃣ **통합 런처 (고급 사용자용)**

통합 런처(`launcher.py`)는 모든 실행 옵션을 제공하는 고급 도구입니다.

#### **🌟 기능:**

- ✅ **자동 의존성 검사**: 필요한 라이브러리 설치 상태 확인
- ✅ **대화형 메뉴**: 사용자 친화적인 모드 선택
- ✅ **관리자 확인**: 관리자 모드 실행 시 안전 확인
- ✅ **동시 실행**: 사용자+관리자 모드 동시 운영
- ✅ **명령행 인수**: 스크립트 자동화 지원

#### **1) 대화형 모드 (권장)**

```bash
python launcher.py
```

**선택 메뉴:**

- `1`: 일반 사용자 모드 → http://localhost:8501
- `2`: 관리자 모드 → http://localhost:8502 (확인 절차 포함)
- `3`: 두 모드 동시 실행 → 양쪽 포트 모두 활성화
- `4`: 종료

#### **2) 직접 모드 지정**

```bash
# 일반 사용자 모드
python launcher.py user

# 관리자 모드 (확인 절차 포함)
python launcher.py admin

# 두 모드 동시 실행
python launcher.py both

# 의존성 검사 건너뛰기
python launcher.py user --no-check
```

#### **3) 환경변수 설정**

```bash
# 관리자 확인 절차 건너뛰기 (Windows)
set ADMIN_MODE=1
python launcher.py admin

# 관리자 확인 절차 건너뛰기 (Linux/macOS)
export ADMIN_MODE=1
python launcher.py admin
```

---

### 📋 **접속 주소 정리**

| 실행 방법             | 접속 주소             | 용도           | 특징        |
| --------------------- | --------------------- | -------------- | ----------- |
| `python run.py`       | http://localhost:8501 | 👤 일반 사용자 | 간단, 안전  |
| `python run_admin.py` | http://localhost:8502 | 🛠️ 관리자      | 완전 제어   |
| `python launcher.py`  | **선택 가능**         | 🎭 통합 관리   | 대화형 메뉴 |

---

### 🚀 **시스템 사용법**

#### 👤 **일반 사용자**

1. API 키 입력 (자동 로드되면 생략)
2. 바로 질문 시작!

#### 🛠️ **관리자**

1. API 키 및 고급 설정
2. 데이터베이스 관리 옵션 선택
3. "시스템 초기화" 버튼 클릭
4. 시스템 테스트 및 관리

---

> **💡 새로운 시스템의 장점:**
>
> - **사용자별 맞춤 인터페이스**: 역할에 맞는 최적화된 UI
> - **안전성 향상**: 일반 사용자의 실수로 인한 시스템 파괴 방지
> - **관리 편의성**: 관리자는 모든 기능에 접근 가능
> - **자동 의존성 검증**: 누락된 라이브러리 자동 감지

## 📁 프로젝트 구조

```
inflearn-streamlit/
├── 👤 app.py                    # 일반 사용자 인터페이스
├── 🛠️ admin.py                  # 관리자 인터페이스
├── 🚀 run.py                    # 사용자용 실행 스크립트
├── 🔧 run_admin.py              # 관리자용 실행 스크립트
├── 🎭 launcher.py               # 통합 런처 (대화형 메뉴, 자동화)
├── 📋 requirements.txt          # Python 의존성
├── 📖 README.md                # 프로젝트 설명서
├── 🔐 env_example.txt           # 환경변수 설정 예시
├── 📚 retrieval/               # RAG 시스템 패키지
│   ├── __init__.py            # 패키지 초기화
│   ├── config.py              # 설정 관리
│   ├── rag_manager.py         # 기존 RAG 시스템 (단일 사용자)
│   ├── shared_rag_manager.py  # 공유 리소스 RAG 시스템 (멀티 사용자)
│   ├── enhanced_rag.py        # 향상된 RAG 시스템
│   ├── database_manager.py    # 데이터베이스 관리
│   ├── embedding_manager.py   # 임베딩 모델 관리
│   ├── conversation_history.py # 대화 히스토리 관리
│   └── command_processor.py   # 명령어 처리
├── 📄 tax.docx                # 소득세 관련 문서
├── 💾 chroma_1/               # 한국어 임베딩 DB (자동 생성)
└── 💾 chroma_2/               # Google Gemini 임베딩 DB (자동 생성)
```

## 🔧 주요 컴포넌트

### 🎭 Launcher (통합 런처)

통합 런처는 시스템의 모든 실행 옵션을 제공하는 고급 관리 도구입니다.

#### **핵심 기능:**

- **의존성 자동 검증**: streamlit, langchain, chromadb 설치 상태 확인
- **대화형 인터페이스**: 직관적인 메뉴 시스템으로 모드 선택
- **안전 장치**: 관리자 모드 실행 시 확인 절차
- **프로세스 관리**: 단일/동시 실행 및 안전한 종료 처리
- **명령행 지원**: 스크립트 자동화를 위한 인수 처리

#### **사용 시나리오:**

- **개발자**: 빠른 테스트를 위한 모드 전환
- **관리자**: 안전한 관리자 모드 접근
- **운영팀**: 두 모드 동시 운영으로 서비스 제공
- **자동화**: CI/CD 파이프라인에서 스크립트 실행

#### **명령어 옵션:**

```bash
python launcher.py           # 대화형 메뉴
python launcher.py user      # 사용자 모드 직접 실행
python launcher.py admin     # 관리자 모드 직접 실행
python launcher.py both      # 동시 실행
python launcher.py --no-check # 의존성 검사 건너뛰기
```

---

### SharedRAGManager (멀티 사용자 지원)

- **공유 리소스 관리**: 임베딩 모델, 데이터베이스, LLM 캐싱
- **사용자 세션 생성**: 개별 사용자별 독립적인 세션 제공
- **메모리 효율성**: 리소스 재사용으로 메모리 사용량 최적화
- **동시 사용자 지원**: 안정적인 멀티 사용자 환경

### UserRAGSession (사용자별 개별 세션)

- **개별 대화 히스토리**: 사용자별 독립적인 대화 기록
- **개별 설정**: 쿼리 최적화 등 사용자별 설정
- **데이터 격리**: 사용자 간 완전한 데이터 분리

### RAGManager (기존 단일 사용자용)

- 단일 사용자 환경을 위한 기존 RAG 시스템
- 임베딩, 데이터베이스, LLM, 대화 히스토리 통합 관리

### EnhancedRAGSystem

- 쿼리 최적화 기능 (세금 관련 용어 개선)
- 문서 검색 및 AI 답변 생성
- 타임아웃 처리 및 오류 복구
- 처리 과정 상세 모니터링

### DatabaseManager

- Chroma 벡터 데이터베이스 관리
- 문서 로딩 및 청킹 (1500자 단위)
- 데이터베이스 생성/로드 및 영속성 관리

### ConversationHistory

- 사용자별 대화 히스토리 관리
- 컨텍스트 추출 및 활용
- 키워드 기반 관련 대화 검색
- 히스토리 제어 기능 (초기화, 토글)

## 🎨 UI 기능

### 👤 **일반 사용자 인터페이스** (app.py - 포트 8501)

#### **사이드바**

- **간단 설정**:
  - Google API 키 입력 (자동 .env 로드)
  - 시스템 상태 표시 (준비완료/초기화중)
  - 대화 수 통계
- **도움말**:
  - 질문 예시 제공
  - 시스템 정보 안내
- **추가 기능**:
  - 새 대화 시작 버튼
  - 관리자 화면 접속 안내

#### **메인 채팅**

- **환영 메시지**: 첫 방문시 사용법 안내
- **자동 초기화**: API 키 입력시 백그라운드 시스템 준비
- **실시간 채팅**: 간단하고 직관적인 대화 인터페이스
- **참고 문서**: 간소화된 문서 미리보기 (최대 2개)
- **친화적 오류 처리**: 사용자 친화적 오류 메시지

---

### 🛠️ **관리자 인터페이스** (admin.py - 포트 8502)

#### **사이드바**

- **시스템 관리**:
  - Google API 키 입력 (자동 .env 로드)
  - 임베딩 모델 선택 (한국어/Google Gemini)
  - 쿼리 최적화 토글
- **데이터베이스 관리**:
  - 데이터베이스 상태 (디스크/메모리/크기)
  - 처리 방식 선택 (auto/reuse/recreate)
  - 위험한 관리 작업 (캐시 제거, DB 삭제)
- **시스템 상태**:
  - 각 컴포넌트 로딩 상태 표시
  - 개별 세션 정보 (임베딩, 데이터베이스, LLM, 대화 기록)
- **공유 리소스 상태**:
  - 캐시된 임베딩 모델 수
  - 캐시된 데이터베이스 수
  - 캐시된 LLM 수
  - 메모리 절약 현황
- **고급 관리 기능**:
  - 대화 기록 초기화
  - 쿼리 최적화 토글
  - DB 캐시 제거
  - 현재 DB 삭제

#### **메인 채팅**

- **관리자 확인**: 접속시 관리자 전용 경고 메시지
- **테스트용 채팅**: 시스템 테스트를 위한 완전한 채팅 기능
- **상세 참고 문서**: 모든 관련 문서 표시
- **상세 오류 정보**: 기술적 오류 메시지 및 디버깅 정보

## 🔍 사용 예시

### 🎭 **Launcher 사용 예시**

#### **대화형 모드 실행:**

```bash
$ python launcher.py
✅ 모든 의존성이 설치되어 있습니다.
🚀 소득세 챗봇 시스템
==================================================
실행할 모드를 선택하세요:
1. 👤 일반 사용자 모드 (포트 8501)
2. 🛠️  관리자 모드 (포트 8502)
3. 🔄 두 모드 동시 실행
4. ❌ 종료
==================================================
선택 (1-4): 1
👤 일반 사용자 모드를 시작합니다...
🌐 브라우저에서 http://localhost:8501 을 열어주세요.
```

#### **직접 모드 실행:**

```bash
$ python launcher.py admin
✅ 모든 의존성이 설치되어 있습니다.
🛠️  관리자 모드를 시작합니다...
⚠️  주의: 이 화면은 시스템 관리자 전용입니다.
관리자 모드를 실행하시겠습니까? (y/N): y
🚀 관리자 대시보드를 시작합니다...
🌐 브라우저에서 http://localhost:8502 를 열어주세요.
```

---

### 💬 **질문 예시**

```
Q: "연봉 5000만원 받는 직장인의 소득세는 얼마인가요?"
A: [RAG 시스템이 관련 문서를 검색하여 정확한 답변 제공]

Q: "공제 항목에는 어떤 것들이 있나요?"
A: [세금 관련 문서에서 공제 항목 정보 검색 후 답변]
```

## ⚠️ 주의사항

1. **API 키 보안**: Google API 키를 안전하게 관리하세요
2. **문서 준비**: `tax.docx` 파일이 필요합니다 (소득세 관련 문서)
3. **인터넷 연결**: 임베딩 모델 다운로드 및 API 호출에 필요
4. **시스템 리소스**: 임베딩 모델 로딩 시 메모리 사용량 증가

## 🐛 문제 해결

### 일반적인 오류

1. **API 키 오류**

   - Google AI Studio에서 올바른 API 키 발급 확인
   - API 키 권한 설정 확인

2. **모델 로딩 실패**

   - 인터넷 연결 확인
   - 충분한 디스크 공간 확보

3. **메모리 부족**

   - 다른 애플리케이션 종료
   - 더 많은 RAM 확보

4. **실행 스크립트 오류**

   - `python run.py` (사용자 모드) 또는 `python run_admin.py` (관리자 모드) 실행 시 의존성 오류가 표시되면:
     ```bash
     pip install -r requirements.txt
     ```
   - Unix/Linux에서 권한 오류 시:
     ```bash
     chmod +x run.py run_admin.py launcher.py
     ```

5. **포트 충돌 오류**

   - 포트 8501 또는 8502가 이미 사용 중인 경우:

     ```bash
     # 사용 중인 포트 확인
     netstat -an | findstr :8501
     netstat -an | findstr :8502

     # 직접 다른 포트로 실행
     streamlit run app.py --server.port 8503
     streamlit run admin.py --server.port 8504
     ```

6. **인터페이스 구분 오류**
   - **일반 사용자**: http://localhost:8501 (app.py)
   - **관리자**: http://localhost:8502 (admin.py)
   - 잘못된 포트로 접속하면 원하는 기능을 사용할 수 없습니다

## 🌐 멀티 사용자 지원

### 아키텍처

- **공유 리소스**: 임베딩 모델, 벡터 데이터베이스, LLM은 전체 사용자가 공유
- **개별 세션**: 대화 히스토리, 설정은 사용자별 독립 관리
- **메모리 효율성**: 첫 번째 사용자 이후 90% 이상 빠른 초기화

### 성능 특징

- **첫 번째 사용자**: 전체 리소스 로딩 (30초 소요)
- **추가 사용자들**: 캐시된 리소스 활용 (3초 내 초기화)
- **동시 사용자**: 안정적인 멀티 세션 지원
- **리소스 절약**: 10명 사용자 시 메모리 사용량 70% 감소

## 📈 향후 개선 계획

### 🎨 **UI/UX 개선**

- [x] 사용자/관리자 인터페이스 분리
- [ ] 모바일 최적화
- [ ] 다크모드 지원
- [ ] 실시간 알림 시스템

### 🔐 **보안 및 인증**

- [ ] 사용자 인증 및 권한 관리
- [ ] 관리자 로그인 시스템
- [ ] API 키 암호화 저장
- [ ] 사용자별 데이터 격리 강화

### 📚 **기능 확장**

- [ ] 다중 문서 형식 지원 (PDF, TXT 등)
- [ ] 실시간 문서 업데이트 기능
- [ ] 답변 품질 평가 시스템
- [ ] 사용자 피드백 시스템
- [ ] 대화 내역 내보내기

### ⚡ **성능 및 확장성**

- [ ] 클러스터링을 통한 수평 확장
- [ ] 더 많은 임베딩 모델 지원
- [ ] 캐시 최적화
- [ ] 로드 밸런싱

## 📄 라이선스

이 프로젝트는 MIT 라이선스 하에 배포됩니다.

## 🤝 기여하기

1. Fork the Project
2. Create your Feature Branch (`git checkout -b feature/AmazingFeature`)
3. Commit your Changes (`git commit -m 'Add some AmazingFeature'`)
4. Push to the Branch (`git push origin feature/AmazingFeature`)
5. Open a Pull Request

## 📞 문의

프로젝트에 대한 문의사항이 있으시면 이슈를 생성해주세요.
